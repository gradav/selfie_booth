# Selfie Booth - Apache Configuration for InMotion Hosting
# Optimized for static files with API backend

# Enable RewriteEngine
RewriteEngine On

# ============ Security Headers ============

# Prevent access to sensitive files
<FilesMatch "\.(env|log|md|txt|py|pyc|pyo|pyd|ini|conf|config|bak|backup|old|orig|save|swp|tmp|~)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Prevent directory browsing
Options -Indexes

# Security headers
<IfModule mod_headers.c>
    # Basic security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy for production
    Header always set Content-Security-Policy "default-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' blob:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; connect-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self';"
    
    # Remove server signature
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# ============ Performance Optimization ============

# Enable compression
<IfModule mod_deflate.c>
    # Compress HTML, CSS, JavaScript, Text, XML and fonts
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE application/x-font
    AddOutputFilterByType DEFLATE application/x-font-opentype
    AddOutputFilterByType DEFLATE application/x-font-otf
    AddOutputFilterByType DEFLATE application/x-font-truetype
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
</IfModule>

# Cache static assets
<IfModule mod_expires.c>
    ExpiresActive On
    
    # HTML files (short cache for dynamic updates)
    ExpiresByType text/html "access plus 1 hour"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # Images
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # Fonts
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # Default
    ExpiresDefault "access plus 1 month"
</IfModule>

# Add ETags for better caching
<IfModule mod_headers.c>
    # Add cache headers for static assets
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|svg|ico|woff|woff2)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # HTML files get shorter cache
    <FilesMatch "\.html$">
        Header set Cache-Control "public, max-age=3600, must-revalidate"
    </FilesMatch>
</IfModule>

# ============ URL Routing ============

# API Routes - Forward to Python backend
# Note: Adjust the path based on your actual API structure
RewriteRule ^api/(.*)$ api/app.py/$1 [QSA,L]

# Short URL redirects for tablets
RewriteRule ^1/?$ mobile.html?tablet_id=TABLET1&location=lobby [R=302,L]
RewriteRule ^2/?$ mobile.html?tablet_id=TABLET2&location=entrance [R=302,L]
RewriteRule ^3/?$ mobile.html?tablet_id=TABLET3&location=event_hall [R=302,L]
RewriteRule ^4/?$ mobile.html?tablet_id=TABLET4&location=party_room [R=302,L]

# Legacy URL support
RewriteRule ^selfie_booth/?$ index.html [L]
RewriteRule ^selfie_booth/mobile/?$ mobile.html [L]
RewriteRule ^selfie_booth/verify/?$ verify.html [L]
RewriteRule ^selfie_booth/photo_session/?$ photo.html [L]
RewriteRule ^selfie_booth/admin/?$ admin.html [L]

# Mobile-specific routes
RewriteRule ^mobile/?$ mobile.html [L]
RewriteRule ^verify/?$ verify.html [L]
RewriteRule ^photo/?$ photo.html [L]
RewriteRule ^admin/?$ admin.html [L]

# Default route - serve kiosk display for root
RewriteRule ^/?$ index.html [L]

# ============ MIME Types ============

<IfModule mod_mime.c>
    # JavaScript
    AddType application/javascript .js
    AddType text/javascript .js
    
    # CSS
    AddType text/css .css
    
    # Images
    AddType image/svg+xml .svg
    AddType image/webp .webp
    
    # Fonts
    AddType font/woff .woff
    AddType font/woff2 .woff2
    AddType application/font-woff .woff
    AddType application/font-woff2 .woff2
    
    # JSON
    AddType application/json .json
    
    # Web App Manifest
    AddType application/manifest+json .webmanifest
</IfModule>

# ============ Error Pages ============

# Custom error pages
ErrorDocument 404 /error404.html
ErrorDocument 500 /error500.html

# ============ HTTPS Redirect (if available) ============

# Uncomment the following lines if you have SSL/HTTPS enabled
# RewriteCond %{HTTPS} !=on
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ============ Development vs Production ============

# Development - Allow CORS for local testing
<IfModule mod_headers.c>
    # Only enable CORS in development
    # Remove or comment out in production
    SetEnvIf Origin "http(s)?://(localhost|127\.0\.0\.1)(:[0-9]+)?$" AccessControlAllowOrigin=$0
    Header add Access-Control-Allow-Origin %{AccessControlAllowOrigin}e env=AccessControlAllowOrigin
    Header merge Vary Origin
</IfModule>

# ============ File Upload Limits ============

# Increase upload limits for photo uploads
<IfModule mod_php.c>
    php_value upload_max_filesize 16M
    php_value post_max_size 16M
    php_value max_execution_time 300
    php_value max_input_time 300
</IfModule>

# ============ Prevent Hotlinking ============

# Prevent hotlinking of images (optional)
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yourdomain\.com [NC]
RewriteCond %{REQUEST_URI} \.(gif|jpe?g|png|svg)$ [NC]
RewriteRule .* - [F,L]

# ============ Browser Caching Directives ============

<IfModule mod_headers.c>
    # Remove ETags (we're using Expires headers)
    Header unset ETag
    FileETag None
    
    # Enable KeepAlive
    Header set Connection keep-alive
</IfModule>

# ============ URL Cleanup ============

# Remove trailing slashes
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} (.+)/$
RewriteRule ^(.+)/$ /$1 [R=301,L]

# Force lowercase URLs
RewriteMap lc int:tolower
RewriteCond %{REQUEST_URI} [A-Z]
RewriteRule (.*) ${lc:$1} [R=301,L]

# ============ Special Cases ============

# Handle favicon requests
RewriteRule ^favicon\.ico$ assets/images/favicon.ico [L]

# Handle robots.txt
RewriteRule ^robots\.txt$ robots.txt [L]

# Handle sitemap
RewriteRule ^sitemap\.xml$ sitemap.xml [L]

# ============ Debugging (Development Only) ============

# Enable logging for debugging (disable in production)
# LogLevel alert rewrite:trace3
# ErrorLog /path/to/error.log
# CustomLog /path/to/access.log combined

# ============ Final Catch-All ============

# If nothing else matches, try to serve the file directly
# If file doesn't exist, serve 404
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule .* - [R=404,L]